!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Centrifuge",[],t):"object"==typeof exports?exports.Centrifuge=t():e.Centrifuge=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});var n=(t.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},t.startsWith=function(e,t){return 0===e.lastIndexOf(t,0)},t.stripSlash=function(e){return"/"===e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e},t.isString=function(e){return void 0!==e&&null!==e&&("string"==typeof e||e instanceof String)},t.isFunction=function(e){return void 0!==e&&null!==e&&"function"==typeof e});t.log=function(t,r){if(e.console){var s=e.console[t];n(s)&&s.apply(e.console,r)}},t.backoff=function(e,t,n){var r=.5*Math.random(),s=t*Math.pow(2,e+1);return s>n&&(s=n),Math.floor((1-r)*s)},t.errorExists=function(e){return"error"in e&&null!==e.error}}).call(t,n(0))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CONNECT=0,t.REFRESH=1,t.SUBSCRIBE=2,t.UNSUBSCRIBE=3,t.PUBLISH=4,t.PRESENCE=5,t.PRESENCE_STATS=6,t.HISTORY=7,t.PING=8,t.RPC=9,t.MESSAGE=10,t.Commands={CONNECT:"connect",REFRESH:"refresh",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",PUBLISH:"publish",PRESENCE:"presence",PRESENCE_STATS:"presence_stats",HISTORY:"history",PING:"ping",RPC:"rpc",MESSAGE:"message"}},function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function s(e){return"number"==typeof e}function i(e){return"object"==typeof e&&null!==e}function o(e){return void 0===e}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!s(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,s,u,c,a;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(n=this._events[e],o(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:u=Array.prototype.slice.call(arguments,1),n.apply(this,u)}else if(i(n))for(u=Array.prototype.slice.call(arguments,1),a=n.slice(),s=a.length,c=0;c<s;c++)a[c].apply(this,u);return!0},n.prototype.addListener=function(e,t){var s;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(s=o(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){function n(){this.removeListener(e,n),s||(s=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var s=!1;return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,t){var n,s,o,u;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],o=n.length,s=-1,n===t||r(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(n)){for(u=o;u-- >0;)if(n[u]===t||n[u].listener&&n[u].listener===t){s=u;break}if(s<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],r(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(r(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,n){(function(t,n){/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   v4.2.4+314e4831
 */
!function(t,n){e.exports=n()}(0,function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function r(e){return"function"==typeof e}function s(e){H=e}function i(e){J=e}function o(){return void 0!==F?function(){F(c)}:u()}function u(){var e=setTimeout;return function(){return e(c,1)}}function c(){for(var e=0;e<D;e+=2){(0,Y[e])(Y[e+1]),Y[e]=void 0,Y[e+1]=void 0}D=0}function a(e,t){var n=this,r=new this.constructor(h);void 0===r[$]&&x(r);var s=n._state;if(s){var i=arguments[s-1];J(function(){return T(s,r,i,n._result)})}else w(n,r,e,t);return r}function l(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(h);return y(n,e),n}function h(){}function f(){return new TypeError("You cannot resolve a promise with itself")}function _(){return new TypeError("A promises callback cannot return that same promise.")}function d(e){try{return e.then}catch(e){return ee.error=e,ee}}function p(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}function v(e,t,n){J(function(e){var r=!1,s=p(n,t,function(n){r||(r=!0,t!==n?y(e,n):k(e,n))},function(t){r||(r=!0,S(e,t))},"Settle: "+(e._label||" unknown promise"));!r&&s&&(r=!0,S(e,s))},e)}function b(e,t){t._state===V?k(e,t._result):t._state===Z?S(e,t._result):w(t,void 0,function(t){return y(e,t)},function(t){return S(e,t)})}function g(e,t,n){t.constructor===e.constructor&&n===a&&t.constructor.resolve===l?b(e,t):n===ee?(S(e,ee.error),ee.error=null):void 0===n?k(e,t):r(n)?v(e,t,n):k(e,t)}function y(t,n){t===n?S(t,f()):e(n)?g(t,n,d(n)):k(t,n)}function m(e){e._onerror&&e._onerror(e._result),E(e)}function k(e,t){e._state===Q&&(e._result=t,e._state=V,0!==e._subscribers.length&&J(E,e))}function S(e,t){e._state===Q&&(e._state=Z,e._result=t,J(m,e))}function w(e,t,n,r){var s=e._subscribers,i=s.length;e._onerror=null,s[i]=t,s[i+V]=n,s[i+Z]=r,0===i&&e._state&&J(E,e)}function E(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,s=void 0,i=e._result,o=0;o<t.length;o+=3)r=t[o],s=t[o+n],r?T(n,r,s,i):s(i);e._subscribers.length=0}}function C(e,t){try{return e(t)}catch(e){return ee.error=e,ee}}function T(e,t,n,s){var i=r(n),o=void 0,u=void 0,c=void 0,a=void 0;if(i){if(o=C(n,s),o===ee?(a=!0,u=o.error,o.error=null):c=!0,t===o)return void S(t,_())}else o=s,c=!0;t._state!==Q||(i&&c?y(t,o):a?S(t,u):e===V?k(t,o):e===Z&&S(t,o))}function j(e,t){try{t(function(t){y(e,t)},function(t){S(e,t)})}catch(t){S(e,t)}}function R(){return te++}function x(e){e[$]=te++,e._state=void 0,e._result=void 0,e._subscribers=[]}function O(){return new Error("Array Methods must be provided an Array")}function P(e){return new ne(this,e).promise}function A(e){var t=this;return new t(U(e)?function(n,r){for(var s=e.length,i=0;i<s;i++)t.resolve(e[i]).then(n,r)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function I(e){var t=this,n=new t(h);return S(n,e),n}function M(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function L(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function B(){var e=void 0;if(void 0!==n)e=n;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=re}var N=void 0;N=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var U=N,D=0,F=void 0,H=void 0,J=function(e,t){Y[D]=e,Y[D+1]=t,2===(D+=2)&&(H?H(c):K())},q="undefined"!=typeof window?window:void 0,W=q||{},X=W.MutationObserver||W.WebKitMutationObserver,z="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),G="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Y=new Array(1e3),K=void 0;K=z?function(){return function(){return t.nextTick(c)}}():X?function(){var e=0,t=new X(c),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}():G?function(){var e=new MessageChannel;return e.port1.onmessage=c,function(){return e.port2.postMessage(0)}}():void 0===q?function(){try{var e=Function("return this")().require("vertx");return F=e.runOnLoop||e.runOnContext,o()}catch(e){return u()}}():u();var $=Math.random().toString(36).substring(2),Q=void 0,V=1,Z=2,ee={error:null},te=0,ne=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(h),this.promise[$]||x(this.promise),U(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?k(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&k(this.promise,this._result))):S(this.promise,O())}return e.prototype._enumerate=function(e){for(var t=0;this._state===Q&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===l){var s=d(e);if(s===a&&e._state!==Q)this._settledAt(e._state,t,e._result);else if("function"!=typeof s)this._remaining--,this._result[t]=e;else if(n===re){var i=new n(h);g(i,e,s),this._willSettleAt(i,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},e.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===Q&&(this._remaining--,e===Z?S(r,n):this._result[t]=n),0===this._remaining&&k(r,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;w(e,void 0,function(e){return n._settledAt(V,t,e)},function(e){return n._settledAt(Z,t,e)})},e}(),re=function(){function e(t){this[$]=R(),this._result=this._state=void 0,this._subscribers=[],h!==t&&("function"!=typeof t&&M(),this instanceof e?j(this,t):L())}return e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(e){var t=this,n=t.constructor;return t.then(function(t){return n.resolve(e()).then(function(){return t})},function(t){return n.resolve(e()).then(function(){throw t})})},e}();return re.prototype.then=a,re.all=P,re.race=A,re.resolve=l,re.reject=I,re._setScheduler=s,re._setAsap=i,re._asap=J,re.polyfill=B,re.Promise=re,re})}).call(t,n(7),n(0))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(6),s=function(e){return e&&e.__esModule?e:{default:e}}(r);t.default=s.default,e.exports=t.default},function(e,t,n){"use strict";(function(r){function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(1),l=n(2),h=n(3),f=n(4),_=n(8),d=function(e){function t(e,n){s(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r._url=e,r._sockjs=null,r._isSockjs=!1,r._status="disconnected",r._reconnect=!0,r._reconnecting=!1,r._transport=null,r._transportName=null,r._transportClosed=!0,r._messageId=0,r._clientID=null,r._subs={},r._lastPublicationUID={},r._messages=[],r._isBatching=!1,r._isAuthBatching=!1,r._authChannels={},r._numRefreshFailed=0,r._refreshTimeout=null,r._pingInterval=null,r._pongTimeout=null,r._retries=0,r._callbacks={},r._latency=null,r._latencyStart=null,r._credentials=null,r._config={sockjs:null,retry:1e3,maxRetry:2e4,timeout:5e3,resubscribe:!0,ping:!0,pingInterval:3e4,pongWaitTimeout:5e3,debug:!1,insecure:!1,privateChannelPrefix:"$",onTransportClose:null,sockjsTransports:["websocket","xdr-streaming","xhr-streaming","eventsource","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"],sockjsServer:null,refreshEndpoint:"/centrifuge/refresh",refreshHeaders:{},refreshParams:{},refreshData:{},refreshAttempts:null,refreshInterval:3e3,onRefreshFailed:null,onRefresh:null,authEndpoint:"/centrifuge/auth",authHeaders:{},authParams:{},onAuth:null},r._configure(n),r}return o(t,e),c(t,[{key:"setCredentials",value:function(e){this._credentials=e}},{key:"_ajax",value:function(e,t,n,s,i){var o=this,u="";o._debug("sending AJAX request to",e);var c=r.XMLHttpRequest?new r.XMLHttpRequest:new r.ActiveXObject("Microsoft.XMLHTTP");for(var a in t)t.hasOwnProperty(a)&&(u.length>0&&(u+="&"),u+=encodeURIComponent(a)+"="+encodeURIComponent(t[a]));u.length>0&&(u="?"+u),c.open("POST",e+u,!0),"withCredentials"in c&&(c.withCredentials=!0),c.setRequestHeader("X-Requested-With","XMLHttpRequest"),c.setRequestHeader("Content-Type","application/json");for(var l in n)n.hasOwnProperty(l)&&c.setRequestHeader(l,n[l]);return c.onreadystatechange=function(){if(4===c.readyState)if(200===c.status){var e=void 0,t=!1;try{e=JSON.parse(c.responseText),t=!0}catch(e){i(!0,"JSON returned was invalid, yet status code was 200. Data was: "+c.responseText)}t&&i(!1,e)}else o._log("Couldn't get auth info from application",c.status),i(!0,c.status)},setTimeout(function(){c.send(JSON.stringify(s))},20),c}},{key:"_log",value:function(){(0,a.log)("info",arguments)}},{key:"_debug",value:function(){!0===this._config.debug&&(0,a.log)("debug",arguments)}},{key:"_websocketSupported",value:function(){return!("function"!=typeof WebSocket&&"object"!==("undefined"==typeof WebSocket?"undefined":u(WebSocket)))}},{key:"_sockjsEndpoint",value:function(){var e=this._url;return e=e.replace("ws://","http://").replace("wss://","https://"),e=(0,a.stripSlash)(e),(0,a.endsWith)(this._url,"connection/sockjs")||(e+="/connection/sockjs"),e}},{key:"_websocketEndpoint",value:function(){var e=this._url;return e=e.replace("http://","ws://").replace("https://","wss://"),e=(0,a.stripSlash)(e),(0,a.endsWith)(this._url,"connection/websocket")||(e+="/connection/websocket"),e}},{key:"_configure",value:function(e){if(Object.assign(this._config,e||{}),this._debug("centrifuge config",this._config),!this._url)throw new Error("url required");if(null!==this._credentials){if(!this._credentials.user&&""!==this._credentials.user){if(!this._config.insecure)throw new Error("Missing required credentials parameter user");this._debug("user not found but this is OK for insecure mode")}if(this._credentials.info||(this._credentials.info=""),!this._credentials.exp){if(!this._config.insecure)throw new Error("Missing required credentials parameter exp");this._debug("exp not found but this is OK for insecure mode")}if(!this._credentials.sign){if(!this._config.insecure)throw new Error("Missing required credentials parameter sign");this._debug("sign not found but this is OK for insecure mode")}}if((0,a.endsWith)(this._url,"connection/sockjs"))if(this._debug("client will connect to SockJS endpoint"),null!==this._config.sockjs)this._debug("SockJS explicitly provided in options"),this._sockjs=this._config.sockjs;else{if(void 0===r.SockJS)throw new Error("SockJS not found");this._debug("use globally defined SockJS"),this._sockjs=r.SockJS}else(0,a.endsWith)(this._url,"connection/websocket")?this._debug("client will connect to websocket endpoint"):(this._debug("client will detect connection endpoint itself"),null!==this._config.sockjs?(this._debug("SockJS explicitly provided in options"),this._sockjs=this._config.sockjs):void 0===r.SockJS?this._debug("SockJS not found"):(this._debug("use globally defined SockJS"),this._sockjs=r.SockJS))}},{key:"_setStatus",value:function(e){this._status!==e&&(this._debug("Status",this._status,"->",e),this._status=e)}},{key:"_isDisconnected",value:function(){return"disconnected"===this._status}},{key:"_isConnecting",value:function(){return"connecting"===this._status}},{key:"_isConnected",value:function(){return"connected"===this._status}},{key:"_nextMessageId",value:function(){return++this._messageId}},{key:"_resetRetry",value:function(){this._debug("reset retries count to 0"),this._retries=0}},{key:"_getRetryInterval",value:function(){var e=(0,a.backoff)(this._retries,this._config.retry,this._config.maxRetry);return this._retries+=1,e}},{key:"_clearConnectedState",value:function(e){this._clientID=null;for(var t in this._callbacks)if(this._callbacks.hasOwnProperty(t)){var n=this._callbacks[t],r=n.errback;if(!r)continue;r(this._createErrorObject("disconnected"))}this._callbacks={};for(var s in this._subs)if(this._subs.hasOwnProperty(s)){var i=this._subs[s];e?(i._isSuccess()&&i._triggerUnsubscribe(),i._setSubscribing()):i._setUnsubscribed()}this._config.resubscribe&&this._reconnect||(this._subs={})}},{key:"_send",value:function(e){if(0!==e.length){this._debug("Send",e);var t=[];for(var n in e){var r=e[n];t.push(JSON.stringify(r))}this._transport.send(t.join("\n"))}}},{key:"_setupTransport",value:function(){var e=this;if(this._isSockjs=!1,null!==this._sockjs){var t={transports:this._config.sockjsTransports};null!==this._config.sockjsServer&&(t.server=this._config.sockjsServer),this._isSockjs=!0,this._transport=new this._sockjs(this._sockjsEndpoint(),null,t)}else{if(!this._websocketSupported())return void this._debug("No Websocket support and no SockJS configured, can not connect");this._transport=new WebSocket(this._websocketEndpoint())}this._transport.onopen=function(){e._transportClosed=!1,e._reconnecting=!1,e._isSockjs?(e._transportName="sockjs-"+e._transport.transport,e._transport.onheartbeat=function(){e._restartPing()}):e._transportName="websocket",e._resetRetry();var t={method:l.Commands.CONNECT};e._credentials&&(t.params=e._credentials),e._latencyStart=new Date,e._call(t).then(function(t){e._connectResponse(t)},function(){e._disconnect("connect error",!0)})},this._transport.onerror=function(t){e._debug("transport level error",t)},this._transport.onclose=function(t){e._transportClosed=!0;var n="connection closed",r=!0;if(t&&"reason"in t&&t.reason)try{var s=JSON.parse(t.reason);e._debug("reason is an advice object",s),n=s.reason,r=s.reconnect}catch(s){n=t.reason,e._debug("reason is a plain string",n),r="disconnect"!==n}if(null!==e._config.onTransportClose&&e._config.onTransportClose({event:t,reason:n,reconnect:r}),e._disconnect(n,r),!0===e._reconnect){e._reconnecting=!0;var i=e._getRetryInterval();e._debug("reconnect after "+i+" milliseconds"),setTimeout(function(){!0===e._reconnect&&e._connect.call(e)},i)}},this._transport.onmessage=function(t){var n=t.data.split("\n");for(var r in n)if(n.hasOwnProperty(r)){if(!n[r])continue;var s=JSON.parse(n[r]);e._debug("Received",s),e._receive(s)}e._restartPing()}}},{key:"rpc",value:function(e){var t={method:l.Commands.RPC,params:{data:e}},n=this._call(t);return new f(function(e,t){n.then(function(t){e(t.data)},function(e){t(e)})})}},{key:"send",value:function(e){var t={method:l.Commands.MESSAGE,params:{data:e}};return this._callAsync(t)}},{key:"_callAsync",value:function(e){this._addMessage(e,!0)}},{key:"_call",value:function(e){var t=this;return new f(function(n,r){var s=t._addMessage(e);t._registerCall(s,n,r)})}},{key:"_connect",value:function(e){if(this.isConnected())return void this._debug("connect called when already connected");"connecting"!==this._status&&(this._debug("start connecting"),this._setStatus("connecting"),this._clientID=null,this._reconnect=!0,e&&this.on("connect",e),this._setupTransport())}},{key:"_disconnect",value:function(e,t){if(!this.isDisconnected()){this._debug("disconnected:",e,t);var n=t||!1;!1===n&&(this._reconnect=!1),this._clearConnectedState(n),this.isDisconnected()||(this._setStatus("disconnected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout),!1===this._reconnecting&&this.emit("disconnect",{reason:e,reconnect:n})),this._transportClosed||this._transport.close()}}},{key:"_refreshFailed",value:function(){this._numRefreshFailed=0,this.isDisconnected()||this._disconnect("refresh failed",!1),null!==this._config.onRefreshFailed&&this._config.onRefreshFailed()}},{key:"_refresh",value:function(){var e=this;if(this._debug("refresh credentials"),0===e._config.refreshAttempts)return this._debug("refresh attempts set to 0, do not send refresh request at all"),void e._refreshFailed();null!==e._refreshTimeout&&clearTimeout(e._refreshTimeout);var t=function(t,n){if(!0===t)return e._debug("error getting connection credentials from refresh endpoint",n),e._numRefreshFailed++,e._refreshTimeout&&clearTimeout(e._refreshTimeout),null!==e._config.refreshAttempts&&e._numRefreshFailed>=e._config.refreshAttempts?void e._refreshFailed():void(e._refreshTimeout=setTimeout(function(){e._refresh.call(e)},e._config.refreshInterval+Math.round(1e3*Math.random())));e._numRefreshFailed=0,null!==e._credentials&&(e._credentials.user=n.user,e._credentials.exp=n.exp,"info"in n&&(e._credentials.info=n.info),e._credentials.sign=n.sign,e.isDisconnected()?(e._debug("credentials refreshed, connect from scratch"),e._connect()):(e._debug("send refreshed credentials"),e._addMessage({method:l.Commands.REFRESH,params:e._credentials})))};if(null!==this._config.onRefresh){var n={};this._config.onRefresh(n,t)}else this._ajax(this._config.refreshEndpoint,this._config.refreshParams,this._config.refreshHeaders,this._config.refreshData,t)}},{key:"_subscribe",value:function(e){var t=e.channel;if(t in this._subs||(this._subs[t]=e),!this.isConnected())return void e._setNew();e._setSubscribing();var n={method:l.Commands.SUBSCRIBE,params:{channel:t}};if((0,a.startsWith)(t,this._config.privateChannelPrefix))this._isAuthBatching?this._authChannels[t]=!0:(this.startAuthBatching(),this._subscribe(e),this.stopAuthBatching());else{!0===this._recover(t)&&(n.params.recover=!0,n.params.last=this._getLastID(t));var r=this;this._call(n).then(function(e){r._subscribeResponse(t,e)},function(e){r._subscribeError(e)})}}},{key:"_unsubscribe",value:function(e){this.isConnected()&&this._addMessage({method:l.Commands.UNSUBSCRIBE,params:{channel:e.channel}})}},{key:"_getSub",value:function(e){var t=this._subs[e];return t||null}},{key:"_connectResponse",value:function(e){if(!this.isConnected()){if(null!==this._latencyStart&&(this._latency=(new Date).getTime()-this._latencyStart.getTime(),this._latencyStart=null),e.expires){if(e.expired)return this._reconnecting=!0,this._disconnect("expired",!0),void this._refresh()}this._clientID=e.client,this._setStatus("connected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout);var t=this;if(e.expires&&(this._refreshTimeout=setTimeout(function(){t._refresh.call(t)},1e3*e.ttl)),this._config.resubscribe){this.startBatching(),this.startAuthBatching();for(var n in this._subs)if(this._subs.hasOwnProperty(n)){var r=this._subs[n];r._shouldResubscribe()&&this._subscribe(r)}this.stopAuthBatching(),this.stopBatching(!0)}this._restartPing(),this.emit("connect",{client:e.client,transport:this._transportName,latency:this._latency})}}},{key:"_stopPing",value:function(){null!==this._pongTimeout&&clearTimeout(this._pongTimeout),null!==this._pingInterval&&clearInterval(this._pingInterval)}},{key:"_startPing",value:function(){if(!(!0!==this._config.ping||this._config.pingInterval<=0)&&this.isConnected()){var e=this;this._pingInterval=setInterval(function(){if(!e.isConnected())return void e._stopPing();e.ping(),e._pongTimeout=setTimeout(function(){e._disconnect("no ping",!0)},e._config.pongWaitTimeout)},this._config.pingInterval)}}},{key:"_restartPing",value:function(){this._stopPing(),this._startPing()}},{key:"_subscribeResponse",value:function(e,t){var n=this._getSub(e);if(n&&n._isSubscribing()){var r=t.publications;if(r&&r.length>0){r=r.reverse();for(var s in r)r.hasOwnProperty(s)&&this._messageResponse({body:r[s]})}else"last"in t&&(this._lastPublicationUID[e]=t.last);var i=!1;"recovered"in t&&(i=t.recovered),n._setSubscribeSuccess(i)}}},{key:"_unsubscribeResponse",value:function(e){var t=e.uid,n=e.body,r=n.channel,s=this._getSub(r);s&&((0,a.errorExists)(e)?this.emit("error",{message:e}):t||s._setUnsubscribed())}},{key:"_handleResponse",value:function(e){var t=e.id,n=e.result;if(t in this._callbacks){var r=this._callbacks[t];if(delete this._callbacks[t],(0,a.errorExists)(e)){var s=r.errback;if(!s)return;s(e.error),this.emit("error",{message:e})}else{var i=r.callback;if(!i)return;i(n)}}}},{key:"_joinResponse",value:function(e,t){var n=this._getSub(e);n&&n.emit("join",t)}},{key:"_leaveResponse",value:function(e,t){var n=this._getSub(e);n&&n.emit("leave",t)}},{key:"_messageResponse",value:function(e,t){this._lastPublicationUID[e]=t.uid;var n=this._getSub(e);n&&n.emit("message",t)}},{key:"_refreshResponse",value:function(e){if(this._refreshTimeout&&clearTimeout(this._refreshTimeout),(0,a.errorExists)(e))this.emit("error",{message:e});else if(e.body.expires){var t=this,n=e.body.expired;if(n)return void(t._refreshTimeout=setTimeout(function(){t._refresh.call(t)},t._config.refreshInterval+Math.round(1e3*Math.random())));this._clientID=e.body.client,t._refreshTimeout=setTimeout(function(){t._refresh.call(t)},1e3*e.body.ttl)}}},{key:"_handleAsyncMessage",value:function(e){var t=e.result,n=0;"type"in t&&(n=t.type);var r=t.channel;0===n?this._messageResponse(r,t.data):1===n?this._joinResponse(r,t.data):2===n&&this._leaveResponse(r,t.data)}},{key:"_dispatchMessage",value:function(e){if(void 0===e||null===e)return void this._debug("dispatch: got undefined or null message");var t=e.id;t&&t>0?this._handleResponse(e):this._handleAsyncMessage(e)}},{key:"_receive",value:function(e){if(Object.prototype.toString.call(e)===Object.prototype.toString.call([]))for(var t in e)e.hasOwnProperty(t)&&this._dispatchMessage(e[t]);else Object.prototype.toString.call(e)===Object.prototype.toString.call({})&&this._dispatchMessage(e)}},{key:"_flush",value:function(){var e=this._messages.slice(0);this._messages=[],this._send(e)}},{key:"_ping",value:function(){this._addMessage({method:l.Commands.PING})}},{key:"_recover",value:function(e){return e in this._lastPublicationUID}},{key:"_getLastID",value:function(e){var t=this._lastPublicationUID[e];return t?(this._debug("last uid found and sent for channel",e),t):(this._debug("no last uid found for channel",e),"")}},{key:"_createErrorObject",value:function(e,t){return{error:{message:e,code:t||0}}}},{key:"_errorObjectFromMessage",value:function(e){return this._createErrorObject(e.error,e.code)}},{key:"_registerCall",value:function(e,t,n){var r=this;this._callbacks[e]={callback:t,errback:n},setTimeout(function(){delete r._callbacks[e],(0,a.isFunction)(n)&&n(r._createErrorObject("timeout"))},this._config.timeout)}},{key:"_addMessage",value:function(e,t){var n=void 0;return t||(n=this._nextMessageId(),e.id=n),!0===this._isBatching?this._messages.push(e):this._send([e]),t?0:n}},{key:"isConnected",value:function(){return this._isConnected()}},{key:"connect",value:function(){return this._connect()}},{key:"disconnect",value:function(){this._disconnect("client",!1)}},{key:"ping",value:function(){return this._ping()}},{key:"startBatching",value:function(){this._isBatching=!0}},{key:"stopBatching",value:function(e){e=e||!1,this._isBatching=!1,!0===e&&this.flush()}},{key:"flush",value:function(){this._flush()}},{key:"startAuthBatching",value:function(){this._isAuthBatching=!0}},{key:"stopAuthBatching",value:function(){var e,t;this._isAuthBatching=!1;var n=this._authChannels;this._authChannels={};var r=[];for(t in n)if(n.hasOwnProperty(t)){var s=this._getSub(t);if(!s)continue;r.push(t)}if(0!==r.length){var i={client:this._clientID,channels:r},o=this,u=function(n,s){if(!0!==n){var i=!1;o._isBatching||(o.startBatching(),i=!0);for(e in r)if(r.hasOwnProperty(e)){t=r[e];var u=s[t];if(!u){o._subscribeResponse({error:"channel not found in authorization response",body:{channel:t}});continue}if(u.status&&200!==u.status)o._subscribeResponse({error:u.status,body:{channel:t}});else{var c={method:l.Commands.SUBSCRIBE,params:{channel:t,client:o._clientID,info:u.info,sign:u.sign}},a=o._recover(t);!0===a&&(c.params.recover=!0,c.params.last=o._getLastID(t)),o._call(c).then(function(e){o._subscribeResponse(t,e)},function(e){o._subscribeError(t,e)})}}i&&o.stopBatching(!0)}else{o._debug("authorization request failed");for(e in r)r.hasOwnProperty(e)&&(t=r[e],o._subscribeResponse({error:"authorization request failed",body:{channel:t}}))}};null!==this._config.onAuth?this._config.onAuth({data:i},u):this._ajax(this._config.authEndpoint,this._config.authParams,this._config.authHeaders,i,u)}}},{key:"subscribe",value:function(e,t){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!(0,a.isString)(e))throw new Error("Illegal argument type: channel must be a string");if(!this._config.resubscribe&&!this.isConnected())throw new Error("Can not only subscribe in connected state when resubscribe option is off");var n=this._getSub(e);if(null!==n)return n._setEvents(t),n._isUnsubscribed()&&n.subscribe(),n;var r=new _(this,e,t);return this._subs[e]=r,r.subscribe(),r}}]),t}(h);t.default=d,e.exports=t.default}).call(t,n(0))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function s(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function i(e){if(h===clearTimeout)return clearTimeout(e);if((h===r||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(e);try{return h(e)}catch(t){try{return h.call(null,e)}catch(t){return h.call(this,e)}}}function o(){p&&_&&(p=!1,_.length?d=_.concat(d):v=-1,d.length&&u())}function u(){if(!p){var e=s(o);p=!0;for(var t=d.length;t;){for(_=d,d=[];++v<t;)_&&_[v].run();v=-1,t=d.length}_=null,p=!1,i(e)}}function c(e,t){this.fun=e,this.array=t}function a(){}var l,h,f=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{h="function"==typeof clearTimeout?clearTimeout:r}catch(e){h=r}}();var _,d=[],p=!1,v=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];d.push(new c(e,t)),1!==d.length||p||s(u)},c.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=a,f.addListener=a,f.once=a,f.off=a,f.removeListener=a,f.removeAllListeners=a,f.emit=a,f.prependListener=a,f.prependOnceListener=a,f.listeners=function(e){return[]},f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(1),c=n(2),a=n(3),l=n(4),h=0,f=function(e){function t(e,n,i){r(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o._centrifuge=e,o.channel=n,o._status=h,o._error=null,o._isResubscribe=!1,o._recovered=!1,o._ready=!1,o._promise=null,o._noResubscribe=!1,o._setEvents(i),o._initializePromise(),o}return i(t,e),o(t,[{key:"_initializePromise",value:function(){var e=this;this._ready=!1,this._promise=new l(function(t,n){e._resolve=function(n){e._ready=!0,t(n)},e._reject=function(t){e._ready=!0,n(t)}})}},{key:"_setEvents",value:function(e){if(e)if((0,u.isFunction)(e))this.on("message",e);else if(Object.prototype.toString.call(e)===Object.prototype.toString.call({}))for(var t=["message","join","leave","unsubscribe","subscribe","error"],n=0,r=t.length;n<r;n++){var s=t[n];s in e&&this.on(s,e[s])}}},{key:"_isNew",value:function(){return this._status===h}},{key:"_isUnsubscribed",value:function(){return 4===this._status}},{key:"_isSubscribing",value:function(){return 1===this._status}},{key:"_isReady",value:function(){return 2===this._status||3===this._status}},{key:"_isSuccess",value:function(){return 2===this._status}},{key:"_isError",value:function(){return 3===this._status}},{key:"_setNew",value:function(){this._status=h}},{key:"_setSubscribing",value:function(){!0===this._ready&&(this._initializePromise(),this._isResubscribe=!0),this._status=1}},{key:"_setSubscribeSuccess",value:function(e){if(2!==this._status){this._recovered=e,this._status=2;var t=this._getSubscribeSuccessContext(e);this.emit("subscribe",t),this._resolve(t)}}},{key:"_setSubscribeError",value:function(e){if(3!==this._status){this._status=3,this._error=e;var t=this._getSubscribeErrorContext();this.emit("error",t),this._reject(t)}}},{key:"_triggerUnsubscribe",value:function(){this.emit("unsubscribe",{channel:this.channel})}},{key:"_setUnsubscribed",value:function(e){4!==this._status&&(this._status=4,!0===e&&(this._noResubscribe=!0),this._triggerUnsubscribe())}},{key:"_shouldResubscribe",value:function(){return!this._noResubscribe}},{key:"_getSubscribeSuccessContext",value:function(){return{channel:this.channel,isResubscribe:this._isResubscribe,recovered:this._recovered}}},{key:"_getSubscribeErrorContext",value:function(){var e=this._error;return e.channel=this.channel,e.isResubscribe=this._isResubscribe,e}},{key:"ready",value:function(e,t){this._ready&&(this._isSuccess()?e(this._getSubscribeSuccessContext()):t(this._getSubscribeErrorContext()))}},{key:"subscribe",value:function(){2!==this._status&&this._centrifuge._subscribe(this)}},{key:"unsubscribe",value:function(){this._setUnsubscribed(!0),this._centrifuge._unsubscribe(this)}},{key:"_methodCall",value:function(e){var t=this;return new l(function(n,r){if(t._isUnsubscribed())return void r(t._centrifuge._createErrorObject("subscription unsubscribed"));t._promise.then(function(){if(!t._centrifuge.isConnected())return void r(t._centrifuge._createErrorObject("disconnected"));var s=t._centrifuge._addMessage(e);t._centrifuge._registerCall(s,n,r)},function(e){r(e)})})}},{key:"publish",value:function(e){return this._methodCall({method:c.Commands.PUBLISH,params:{channel:self.channel,data:e}})}},{key:"presence",value:function(){return this._methodCall({method:c.Commands.PRESENCE,params:{channel:self.channel}})}},{key:"presenceStats",value:function(){return this._methodCall({method:c.Commands.PRESENCE_STATS,params:{channel:self.channel}})}},{key:"history",value:function(){return this._methodCall({method:c.Commands.HISTORY,params:{channel:self.channel}})}}]),t}(a);t.default=f,e.exports=t.default}])});