(function(){"use strict";function e(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function t(e,t){try{return e[t]}catch(n){return void 0}}function n(e,s){for(var r=s||{},i=2;i<arguments.length;++i){var o=arguments[i];if(void 0!==o&&null!==o)for(var c in o){var a=t(o,c),u=t(r,c);if(a!==s&&void 0!==a)if(e&&"object"==typeof a&&null!==a)if(a instanceof Array)r[c]=n(e,u instanceof Array?u:[],a);else{var h="object"!=typeof u||u instanceof Array?{}:u;r[c]=n(e,h,a)}else r[c]=a}}return r}function s(e,t){return-1!==e.indexOf(t,e.length-t.length)}function r(e,t){return 0===e.lastIndexOf(t,0)}function i(e){return"/"==e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e}function o(e){return void 0===e||null===e?!1:"string"==typeof e||e instanceof String}function c(e){return void 0===e||null===e?!1:"function"==typeof e}function a(e,t){if(window.console){var n=window.console[e];c(n)&&n.apply(window.console,t)}}function u(e,t,n){var s=.5*Math.random(),r=t*Math.pow(2,e+1);return r>n&&(r=n),Math.floor((1-s)*r)}function h(e){return"error"in e&&null!==e.error&&""!==e.error}function f(e){this._sockjs=!1,this._sockjsVersion=null,this._status="disconnected",this._reconnect=!0,this._transport=null,this._latency=null,this._latencyStart=null,this._messageId=0,this._clientID=null,this._subs={},this._lastMessageID={},this._messages=[],this._isBatching=!1,this._isAuthBatching=!1,this._authChannels={},this._refreshTimeout=null,this._retries=0,this._callbacks={},this._config={retry:1e3,maxRetry:2e4,info:"",resubscribe:!0,debug:!1,insecure:!1,server:null,privateChannelPrefix:"$",protocols_whitelist:["websocket","xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"],transports:["websocket","xdr-streaming","xhr-streaming","eventsource","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"],refreshEndpoint:"/centrifuge/refresh",refreshHeaders:{},refreshParams:{},refreshTransport:"ajax",authEndpoint:"/centrifuge/auth",authHeaders:{},authParams:{},authTransport:"ajax"},e&&this.configure(e)}function l(e,t,n){this._status=g,this._error=null,this._centrifuge=e,this.channel=t,this._setEvents(n),this._ready=!1;var s=this;this.promise=new Promise(function(e,t){s._resolve=function(t){s._ready=!0,e(t)},s._reject=function(e){s._ready=!0,t(e)}})}(function(){function e(e){return"function"==typeof e||"object"==typeof e&&null!==e}function t(e){return"function"==typeof e}function n(e){return"object"==typeof e&&null!==e}function s(e){N=e}function r(e){W=e}function i(){return function(){process.nextTick(h)}}function o(){return function(){U(h)}}function c(){var e=0,t=new Y(h),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function a(){var e=new MessageChannel;return e.port1.onmessage=h,function(){e.port2.postMessage(0)}}function u(){return function(){setTimeout(h,1)}}function h(){for(var e=0;X>e;e+=2){var t=G[e],n=G[e+1];t(n),G[e]=void 0,G[e+1]=void 0}X=0}function f(){try{var e=require,t=e("vertx");return U=t.runOnLoop||t.runOnContext,o()}catch(n){return u()}}function l(){}function _(){return new TypeError("You cannot resolve a promise with itself")}function g(){return new TypeError("A promises callback cannot return that same promise.")}function d(e){try{return e.then}catch(t){return tt.error=t,tt}}function p(e,t,n,s){try{e.call(t,n,s)}catch(r){return r}}function b(e,t,n){W(function(e){var s=!1,r=p(n,t,function(n){s||(s=!0,t!==n?y(e,n):S(e,n))},function(t){s||(s=!0,k(e,t))},"Settle: "+(e._label||" unknown promise"));!s&&r&&(s=!0,k(e,r))},e)}function v(e,t){t._state===Z?S(e,t._result):t._state===et?k(e,t._result):j(t,void 0,function(t){y(e,t)},function(t){k(e,t)})}function m(e,n){if(n.constructor===e.constructor)v(e,n);else{var s=d(n);s===tt?k(e,tt.error):void 0===s?S(e,n):t(s)?b(e,n,s):S(e,n)}}function y(t,n){t===n?k(t,_()):e(n)?m(t,n):S(t,n)}function w(e){e._onerror&&e._onerror(e._result),E(e)}function S(e,t){e._state===Q&&(e._result=t,e._state=Z,0!==e._subscribers.length&&W(E,e))}function k(e,t){e._state===Q&&(e._state=et,e._result=t,W(w,e))}function j(e,t,n,s){var r=e._subscribers,i=r.length;e._onerror=null,r[i]=t,r[i+Z]=n,r[i+et]=s,0===i&&e._state&&W(E,e)}function E(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var s,r,i=e._result,o=0;o<t.length;o+=3)s=t[o],r=t[o+n],s?x(n,s,r,i):r(i);e._subscribers.length=0}}function O(){this.error=null}function R(e,t){try{return e(t)}catch(n){return nt.error=n,nt}}function x(e,n,s,r){var i,o,c,a,u=t(s);if(u){if(i=R(s,r),i===nt?(a=!0,o=i.error,i=null):c=!0,n===i)return void k(n,g())}else i=r,c=!0;n._state!==Q||(u&&c?y(n,i):a?k(n,o):e===Z?S(n,i):e===et&&k(n,i))}function C(e,t){try{t(function(t){y(e,t)},function(t){k(e,t)})}catch(n){k(e,n)}}function A(e,t){var n=this;n._instanceConstructor=e,n.promise=new e(l),n._validateInput(t)?(n._input=t,n.length=t.length,n._remaining=t.length,n._init(),0===n.length?S(n.promise,n._result):(n.length=n.length||0,n._enumerate(),0===n._remaining&&S(n.promise,n._result))):k(n.promise,n._validationError())}function M(e){return new st(this,e).promise}function T(e){function t(e){y(r,e)}function n(e){k(r,e)}var s=this,r=new s(l);if(!V(e))return k(r,new TypeError("You must pass an array to race.")),r;for(var i=e.length,o=0;r._state===Q&&i>o;o++)j(s.resolve(e[o]),void 0,t,n);return r}function I(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(l);return y(n,e),n}function L(e){var t=this,n=new t(l);return k(n,e),n}function P(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function D(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function J(e){this._id=at++,this._state=void 0,this._result=void 0,this._subscribers=[],l!==e&&(t(e)||P(),this instanceof J||D(),C(this,e))}function q(){var e;if("undefined"!=typeof global)e=global;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;(!n||"[object Promise]"!==Object.prototype.toString.call(n.resolve())||n.cast)&&(e.Promise=ut)}var B;B=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var U,N,H,V=B,X=0,W=({}.toString,function(e,t){G[X]=e,G[X+1]=t,X+=2,2===X&&(N?N(h):H())}),K="undefined"!=typeof window?window:void 0,z=K||{},Y=z.MutationObserver||z.WebKitMutationObserver,F="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),$="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,G=new Array(1e3);H=F?i():Y?c():$?a():void 0===K&&"function"==typeof require?f():u();var Q=void 0,Z=1,et=2,tt=new O,nt=new O;A.prototype._validateInput=function(e){return V(e)},A.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},A.prototype._init=function(){this._result=new Array(this.length)};var st=A;A.prototype._enumerate=function(){for(var e=this,t=e.length,n=e.promise,s=e._input,r=0;n._state===Q&&t>r;r++)e._eachEntry(s[r],r)},A.prototype._eachEntry=function(e,t){var s=this,r=s._instanceConstructor;n(e)?e.constructor===r&&e._state!==Q?(e._onerror=null,s._settledAt(e._state,t,e._result)):s._willSettleAt(r.resolve(e),t):(s._remaining--,s._result[t]=e)},A.prototype._settledAt=function(e,t,n){var s=this,r=s.promise;r._state===Q&&(s._remaining--,e===et?k(r,n):s._result[t]=n),0===s._remaining&&S(r,s._result)},A.prototype._willSettleAt=function(e,t){var n=this;j(e,void 0,function(e){n._settledAt(Z,t,e)},function(e){n._settledAt(et,t,e)})};var rt=M,it=T,ot=I,ct=L,at=0,ut=J;J.all=rt,J.race=it,J.resolve=ot,J.reject=ct,J._setScheduler=s,J._setAsap=r,J._asap=W,J.prototype={constructor:J,then:function(e,t){var n=this,s=n._state;if(s===Z&&!e||s===et&&!t)return this;var r=new this.constructor(l),i=n._result;if(s){var o=arguments[s-1];W(function(){x(s,r,o,i)})}else j(n,r,e,t);return r},"catch":function(e){return this.then(null,e)}};var ht=q,ft={Promise:ut,polyfill:ht};"function"==typeof define&&define.amd?define(function(){return ft}):"undefined"!=typeof module&&module.exports?module.exports=ft:"undefined"!=typeof this&&(this.ES6Promise=ft),ht()}).call(this),function(){function e(){}function t(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function n(e){return function(){return this[e].apply(this,arguments)}}var s=e.prototype,r=this,i=r.EventEmitter;s.getListeners=function(e){var t,n,s=this._getEvents();if(e instanceof RegExp){t={};for(n in s)s.hasOwnProperty(n)&&e.test(n)&&(t[n]=s[n])}else t=s[e]||(s[e]=[]);return t},s.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},s.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},s.addListener=function(e,n){var s,r=this.getListenersAsObject(e),i="object"==typeof n;for(s in r)r.hasOwnProperty(s)&&-1===t(r[s],n)&&r[s].push(i?n:{listener:n,once:!1});return this},s.on=n("addListener"),s.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},s.once=n("addOnceListener"),s.defineEvent=function(e){return this.getListeners(e),this},s.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},s.removeListener=function(e,n){var s,r,i=this.getListenersAsObject(e);for(r in i)i.hasOwnProperty(r)&&(s=t(i[r],n),-1!==s&&i[r].splice(s,1));return this},s.off=n("removeListener"),s.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},s.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},s.manipulateListeners=function(e,t,n){var s,r,i=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(s=n.length;s--;)i.call(this,t,n[s]);else for(s in t)t.hasOwnProperty(s)&&(r=t[s])&&("function"==typeof r?i.call(this,s,r):o.call(this,s,r));return this},s.removeEvent=function(e){var t,n=typeof e,s=this._getEvents();if("string"===n)delete s[e];else if(e instanceof RegExp)for(t in s)s.hasOwnProperty(t)&&e.test(t)&&delete s[t];else delete this._events;return this},s.removeAllListeners=n("removeEvent"),s.emitEvent=function(e,t){var n,s,r,i,o,c=this.getListenersAsObject(e);for(i in c)if(c.hasOwnProperty(i))for(n=c[i].slice(0),r=n.length;r--;)s=n[r],s.once===!0&&this.removeListener(e,s.listener),o=s.listener.apply(this,t||[]),o===this._getOnceReturnValue()&&this.removeListener(e,s.listener);return this},s.trigger=n("emitEvent"),s.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},s.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},s._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},s._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return r.EventEmitter=i,e},"function"==typeof define&&define.amd?define(function(){return e}):"object"==typeof module&&module.exports?module.exports=e:r.EventEmitter=e}.call(this),Object.create||(Object.create=function(){function e(){}return function(t){if(1!=arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}()),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null==this)throw new TypeError;var t,n,s=Object(this),r=s.length>>>0;if(0===r)return-1;if(t=0,arguments.length>1&&(t=Number(arguments[1]),t!=t?t=0:0!=t&&1/0!=t&&t!=-1/0&&(t=(t>0||-1)*Math.floor(Math.abs(t)))),t>=r)return-1;for(n=t>=0?t:Math.max(r-Math.abs(t),0);r>n;n++)if(n in s&&s[n]===e)return n;return-1}),e(f,EventEmitter),f._authCallbacks={},f._nextAuthCallbackID=1;var _=f.prototype;_._jsonp=function(e,t,n,s,r){n.length>0&&this._log("Only AJAX request allows to send custom headers, it's not possible with JSONP."),self._debug("sending JSONP request to",e);var i=f._nextAuthCallbackID.toString();f._nextAuthCallbackID++;var o=window.document,c=o.createElement("script");f._authCallbacks[i]=function(e){r(!1,e),delete f[i]};var a="";for(var u in t)a.length>0&&(a+="&"),a+=encodeURIComponent(u)+"="+encodeURIComponent(t[u]);var h="Centrifuge._authCallbacks['"+i+"']";c.src=this._config.authEndpoint+"?callback="+encodeURIComponent(h)+"&data="+encodeURIComponent(JSON.stringify(s))+"&"+a;var l=o.getElementsByTagName("head")[0]||o.documentElement;l.insertBefore(c,l.firstChild)},_._ajax=function(e,t,n,s,r){var i=this;i._debug("sending AJAX request to",e);var o=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c="";for(var a in t)c.length>0&&(c+="&"),c+=encodeURIComponent(a)+"="+encodeURIComponent(t[a]);c.length>0&&(c="?"+c),o.open("POST",e+c,!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Content-Type","application/json");for(var u in n)o.setRequestHeader(u,n[u]);return o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var e,t=!1;try{e=JSON.parse(o.responseText),t=!0}catch(n){r(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+o.responseText)}t&&r(!1,e)}else i._log("Couldn't get auth info from your webapp",o.status),r(!0,o.status)},setTimeout(function(){o.send(JSON.stringify(s))},20),o},_._log=function(){a("info",arguments)},_._debug=function(){this._config.debug===!0&&a("debug",arguments)},_._configure=function(e){if(this._debug("Configuring centrifuge object with",e),e||(e={}),this._config=n(!1,this._config,e),!this._config.url)throw"Missing required configuration parameter 'url' specifying server URL";if(!this._config.user&&""!==this._config.user){if(!this._config.insecure)throw"Missing required configuration parameter 'user' specifying user's unique ID in your application";this._debug("user not found but this is OK for insecure mode - anonymous access will be used"),this._config.user=""}if(!this._config.timestamp){if(!this._config.insecure)throw"Missing required configuration parameter 'timestamp'";this._debug("token not found but this is OK for insecure mode")}if(!this._config.token){if(!this._config.insecure)throw"Missing required configuration parameter 'token' specifying the sign of authorization request";this._debug("timestamp not found but this is OK for insecure mode")}if(this._config.url=i(this._config.url),s(this._config.url,"connection")){if(this._debug("client will connect to SockJS endpoint"),"undefined"==typeof SockJS)throw"include SockJS client library before Centrifuge javascript client library or use raw Websocket connection endpoint";this._sockjs=!0,this._sockjsVersion=SockJS.version}else s(this._config.url,"connection/websocket")?(this._debug("client will connect to raw Websocket endpoint"),this._config.url=this._config.url.replace("http://","ws://"),this._config.url=this._config.url.replace("https://","wss://")):(this._debug("client will detect connection endpoint itself"),"undefined"==typeof SockJS?(this._debug("no SockJS found, client will connect to raw Websocket endpoint"),this._config.url+="/connection/websocket",this._config.url=this._config.url.replace("http://","ws://"),this._config.url=this._config.url.replace("https://","wss://")):(this._debug("SockJS found, client will connect to SockJS endpoint"),this._config.url+="/connection",this._sockjs=!0,this._sockjsVersion=SockJS.version))},_._setStatus=function(e){this._status!==e&&(this._debug("Status",this._status,"->",e),this._status=e)},_._isDisconnected=function(){return this._isConnected()===!1},_._isConnected=function(){return"connected"===this._status},_._nextMessageId=function(){return++this._messageId},_._resetRetry=function(){this._debug("reset retries count to 0"),this._retries=0},_._getRetryInterval=function(){var e=u(this._retries,this._config.retry,this._config.maxRetry);return this._retries+=1,e},_._clearConnectedState=function(){this._fireUnsubscribeEvents(),this._config.resubscribe||(this._subs={})},_._send=function(e){0!==e.length&&(this._debug("Send",e),this._transport.send(JSON.stringify(e)))},_._connect=function(e){if(this.isConnected())return void this._debug("connect called when already connected");this._setStatus("connecting"),this._clientID=null,this._reconnect=!0;var t=this;if(e&&this.on("connect",e),this._sockjs===!0){var n={};r(this._sockjsVersion,"1.")?n.transports=this._config.transports:(this._log("SockJS <= 0.3.4 is deprecated, use SockJS >= 1.0.0 instead"),n.protocols_whitelist=this._config.protocols_whitelist),null!==this._config.server&&(n.server=this._config.server),this._transport=new SockJS(this._config.url,null,n)}else this._transport=new WebSocket(this._config.url);this._transport.onopen=function(){t._resetRetry(),o(t._config.user)||t._log("user expected to be string"),o(t._config.info)||t._log("info expected to be string");var e={method:"connect",params:{user:t._config.user,info:t._config.info}};t._config.insecure||(e.params.timestamp=t._config.timestamp,e.params.token=t._config.token,o(t._config.timestamp)||t._log("timestamp expected to be string"),o(t._config.token)||t._log("token expected to be string")),t._addMessage(e),t._latencyStart=new Date},this._transport.onerror=function(e){t._debug("transport level error",e)},this._transport.onclose=function(){if(t._setStatus("disconnected"),t._clearConnectedState(),t.trigger("disconnect"),t._reconnect===!0){var e=t._getRetryInterval();t._debug("reconnect after "+e+" milliseconds"),window.setTimeout(function(){t._reconnect===!0&&t._connect.call(t)},e)}},this._transport.onmessage=function(e){var n;n=JSON.parse(e.data),t._debug("Received",n),t._receive(n)}},_._fireUnsubscribeEvents=function(){for(var e in this._subs){var t=this._subs[e];t._isSuccess()&&t._setUnsubscribed()}},_._disconnect=function(e){var t=e||!1;this._clearConnectedState(),this._clientID=null,this._setStatus("disconnected"),t===!1&&(this._subs={},this._reconnect=!1),this._transport.close()},_._refresh=function(){var e=this;this._debug("refresh credentials");var t=function(t,n){if(t===!0)return e._debug("error getting connect parameters",n),e._refreshTimeout&&window.clearTimeout(e._refreshTimeout),void(e._refreshTimeout=window.setTimeout(function(){e._refresh.call(e)},3e3));if(e._config.user=n.user,e._config.timestamp=n.timestamp,e._config.info=n.info,e._config.token=n.token,e.isDisconnected())e._debug("credentials refreshed, connect from scratch"),e._connect();else{e._debug("send refreshed credentials");var s={method:"refresh",params:{user:e._config.user,timestamp:e._config.timestamp,info:e._config.info,token:e._config.token}};e._addMessage(s)}},n=this._config.refreshTransport.toLowerCase();if("ajax"===n)this._ajax(this._config.refreshEndpoint,this._config.refreshParams,this._config.refreshHeaders,{},t);else{if("jsonp"!==n)throw"Unknown refresh transport "+n;this._jsonp(this._config.refreshEndpoint,this._config.refreshParams,this._config.refreshHeaders,{},t)}},_._subscribe=function(e){var t=e.channel;if(t in this._subs||(this._subs[t]=e),!this.isConnected())return void e._setNew();e._setSubscribing();var n={method:"subscribe",params:{channel:t}};if(r(t,this._config.privateChannelPrefix))this._isAuthBatching?this._authChannels[t]=!0:(this.startAuthBatching(),this._subscribe(e),this.stopAuthBatching());else{var s=this._recover(t);s===!0&&(n.params.recover=!0,n.params.last=this._getLastID(t)),this._addMessage(n)}},_._unsubscribe=function(e){var t=e.channel;if(this.isConnected()){var n={method:"unsubscribe",params:{channel:t}};this._addMessage(n)}},_._getSub=function(e){var t=this._subs[e];return t?t:null},_._addSub=function(e){this._subscribe(e)},_._removeSub=function(e){channel in this._subs&&delete this._subs[channel],this._unsubscribe(e)},_._connectResponse=function(e){if(!this.isConnected()){if(null!==this._latencyStart){var t=new Date;this._latency=t.getTime()-this._latencyStart.getTime(),this._latencyStart=null}if(h(e))this.trigger("error",[e]),this.trigger("connect:error",[this._createErrorObject(e.error)]);else{if(!e.body)return;if(e.body.expires){var n=e.body.expired;if(n)return void this._refresh()}if(this._clientID=e.body.client,this._setStatus("connected"),this.trigger("connect",[e.body]),this._refreshTimeout&&window.clearTimeout(this._refreshTimeout),e.body.expires){var s=this;this._refreshTimeout=window.setTimeout(function(){s._refresh.call(s)},1e3*e.body.ttl)}}if(this._config.resubscribe){this.startBatching(),this.startAuthBatching();for(var r in this._subs){var i=this._subs[r];this._subscribe(i)}this.stopAuthBatching(),this.stopBatching(!0)}}},_._disconnectResponse=function(e){if(h(e))this.trigger("error",[e]);else{var t=!1;"reconnect"in e.body&&(t=e.body.reconnect);var n="";"reason"in e.body&&(n=e.body.reason),n.length>0&&this._debug("disconnected:",n),this.disconnect(t)}},_._subscribeResponse=function(e){var t=e.body;if(null!==t){var n=t.channel,s=this._getSub(n);if(s&&s._isSubscribing())if(h(e))this.trigger("error",[e]),s._setSubscribeError(this._createErrorObject(e.error));else{s._setSubscribeSuccess();var r=t.messages;if(r&&r.length>0)for(var i in r.reverse())this._messageResponse({body:r[i]});else"last"in t&&(this._lastMessageID[n]=t.last)}}},_._unsubscribeResponse=function(e){var t=e.uid,n=e.body,s=n.channel,r=this._getSub(s);r&&(h(e)?this.trigger("error",[e]):t||r._setUnsubscribed())},_._publishResponse=function(e){var t=e.uid,n=e.body;if(t in this._callbacks){var s=this._callbacks[t];if(delete this._callbacks[t],h(e)){var r=s.errback;if(!r)return;r(this._createErrorObject(e.error)),this.trigger("error",[e])}else{var i=s.callback;if(!i)return;i(n)}}},_._presenceResponse=function(e){var t=e.uid,n=e.body;if(t in this._callbacks){var s=this._callbacks[t];if(delete this._callbacks[t],h(e)){var r=s.errback;if(!r)return;r(this._createErrorObject(e.error)),this.trigger("error",[e])}else{var i=s.callback;if(!i)return;i(n)}}},_._historyResponse=function(e){var t=e.uid,n=e.body;if(t in this._callbacks){var s=this._callbacks[t];if(delete this._callbacks[t],h(e)){var r=s.errback;if(!r)return;r(this._createErrorObject(e.error)),this.trigger("error",[e])}else{var i=s.callback;if(!i)return;i(n)}}},_._joinResponse=function(e){var t=e.body,n=t.channel,s=this._getSub(n);s&&s.trigger("join",[t])},_._leaveResponse=function(e){var t=e.body,n=t.channel,s=this._getSub(n);s&&s.trigger("leave",[t])},_._messageResponse=function(e){var t=e.body,n=t.channel;this._lastMessageID[n]=t.uid;var s=this._getSub(n);s&&s.trigger("message",[t])},_._refreshResponse=function(e){if(this._refreshTimeout&&window.clearTimeout(this._refreshTimeout),e.body.expires){var t=this,n=e.body.expired;if(n)return void(t._refreshTimeout=window.setTimeout(function(){t._refresh.call(t)},3e3+Math.round(1e3*Math.random())));this._clientID=e.body.client,t._refreshTimeout=window.setTimeout(function(){t._refresh.call(t)},1e3*e.body.ttl)}},_._dispatchMessage=function(e){if(void 0===e||null===e)return void this._debug("dispatch: got undefined or null message");var t=e.method;if(!t)return void this._debug("dispatch: got message with empty method");switch(t){case"connect":this._connectResponse(e);break;case"disconnect":this._disconnectResponse(e);break;case"subscribe":this._subscribeResponse(e);break;case"unsubscribe":this._unsubscribeResponse(e);break;case"publish":this._publishResponse(e);break;case"presence":this._presenceResponse(e);break;case"history":this._historyResponse(e);break;case"join":this._joinResponse(e);break;case"leave":this._leaveResponse(e);break;case"ping":break;case"refresh":this._refreshResponse(e);break;case"message":this._messageResponse(e);break;default:this._debug("dispatch: got message with unknown method"+t)}},_._receive=function(e){if(Object.prototype.toString.call(e)===Object.prototype.toString.call([])){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];this._dispatchMessage(n)}}else Object.prototype.toString.call(e)===Object.prototype.toString.call({})&&this._dispatchMessage(e)},_._flush=function(){var e=this._messages.slice(0);this._messages=[],this._send(e)},_._ping=function(){var e={method:"ping",params:{}};this._addMessage(e)},_._recover=function(e){return e in this._lastMessageID},_._getLastID=function(e){var t=this._lastMessageID[e];return t?(this._debug("last uid found and sent for channel",e),t):(this._debug("no last uid found for channel",e),"")},_._createErrorObject=function(e){return{error:e}},_._registerCall=function(e,t,n){var s=this;this._callbacks[e]={callback:t,errback:n},setTimeout(function(){delete s._callbacks[e],c(n)&&n(s._createErrorObject("timeout"))},5e3)},_._addMessage=function(e){var t=""+this._nextMessageId();return e.uid=t,this._isBatching===!0?this._messages.push(e):this._send([e]),t},_.getClientId=function(){return this._clientID},_.isConnected=_._isConnected,_.isDisconnected=_._isDisconnected,_.configure=function(e){this._configure.call(this,e)},_.connect=_._connect,_.disconnect=_._disconnect,_.ping=_._ping,_.startBatching=function(){this._isBatching=!0},_.stopBatching=function(e){e=e||!1,this._isBatching=!1,e===!0&&this.flush()},_.flush=function(){this._flush()},_.startAuthBatching=function(){this._isAuthBatching=!0},_.stopAuthBatching=function(e){this._isAuthBatching=!1;var t=this._authChannels;this._authChannels={};var n=[];for(var s in t){var r=this._getSub(s);r&&n.push(s)}if(0==n.length)return void(e&&e());var i={client:this.getClientId(),channels:n},o=this,c=function(t,s){if(t===!0){o._debug("authorization request failed");for(var r in n){var i=n[r];o._subscribeResponse({error:"authorization request failed",body:{channel:i}})}return void(e&&e())}for(var r in n){var i=n[r],c=s[i];if(c)if(c.status&&200!==c.status)o._subscribeResponse({error:c.status,body:{channel:i}});else{var a={method:"subscribe",params:{channel:i,client:o.getClientId(),info:c.info,sign:c.sign}},u=o._recover(i);u===!0&&(a.params.recover=!0,a.params.last=o._getLastID(i)),o._addMessage(a)}else o._subscribeResponse({error:404,body:{channel:i}})}e&&e()},a=this._config.authTransport.toLowerCase();if("ajax"===a)this._ajax(this._config.authEndpoint,this._config.authParams,this._config.authHeaders,i,c);else{if("jsonp"!==a)throw"Unknown auth transport "+a;this._jsonp(this._config.authEndpoint,this._config.authParams,this._config.authHeaders,i,c)}},_.subscribe=function(e,t){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!o(e))throw"Illegal argument type: channel must be a string";if(!this._config.resubscribe&&this.isDisconnected())throw"Can not subscribe in disconnected state when resubscribe option is off";var n=this._getSub(e);if(null!==n)return n._setEvents(t),n;var s=new l(this,e,t);return this._subs[e]=s,s.subscribe(),s};var g=0,d=1,p=2,b=3,v=4;e(l,EventEmitter);var m=l.prototype;m._setEvents=function(e){if(c(e))this.on("message",e);else if(Object.prototype.toString.call(e)===Object.prototype.toString.call({})){var t=["message","join","leave","unsubscribe","subscribe","error","subscribe:success","subscribe:error","resubscribe:success","resubscribe:error"];for(var n in t){var s=t[n];s in e&&this.on(s,e[s])}}},m._isNew=function(){return this._status===g},m._isUnsubscribed=function(){return this._status===v},m._isSubscribing=function(){return this._status===d},m._isReady=function(){return this._status===p||this._status===b},m._isSuccess=function(){return this._status===p},m._isError=function(){return this._status===b},m._setNew=function(){this._status=g},m._setSubscribing=function(){this._status=d},m._setSubscribeSuccess=function(){this._status!=p&&(this._status=p,this._ready?this.trigger("resubscribe:success",[this]):this.trigger("subscribe:success",[this]),this.trigger("subscribe",[this]),this._resolve(this))},m._setSubscribeError=function(e){this._status!=b&&(this._status=b,this._error=e,this._ready?this.trigger("resubscribe:error",e):this.trigger("subscribe:error",e),this.trigger("error",e),this._reject(e))},m._setUnsubscribed=function(){this._status!=v&&(this._status=v,this.trigger("unsubscribe",[this]))},m.ready=function(){return this._isReady()?Promise.resolve(this._isSuccess()?this:this._error):this.promise},m.getStatus=function(){return this._status},m.getError=function(){return this._error},m.subscribe=function(){return this._status!=p?(this._centrifuge._subscribe(this),this):void 0},m.unsubscribe=function(){this._setUnsubscribed(),this._centrifuge._unsubscribe(this)},m.publish=function(e,t,n){var s={method:"publish",params:{channel:this.channel,data:e}},r=this._centrifuge._addMessage(s);this._centrifuge._registerCall(r,t,n)},m.presence=function(e,t){var n={method:"presence",params:{channel:this.channel}},s=this._centrifuge._addMessage(n);this._centrifuge._registerCall(s,e,t)},m.history=function(e,t){var n={method:"history",params:{channel:this.channel}},s=this._centrifuge._addMessage(n);this._centrifuge._registerCall(s,e,t)},"function"==typeof define&&define.amd?define(function(){return f}):"object"==typeof module&&module.exports?module.exports=f:this.Centrifuge=f}).call(this);